#!/usr/bin/env bash
set -euo pipefail

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PID_FILE="$PROJECT_DIR/.imagehive.pid"
LOG_FILE="$PROJECT_DIR/.imagehive.log"
PACKAGE_MANAGER="npm"

read_env_var() {
  local key="$1"
  if [[ -f "$PROJECT_DIR/.env" ]]; then
    local line
    line=$(grep -E "^${key}=" "$PROJECT_DIR/.env" | tail -n1 || true)
    echo "${line#*=}"
  fi
}

APP_PORT=${PORT:-$(read_env_var PORT)}
APP_PORT=${APP_PORT:-3000}
APP_HOST=${HOST:-$(read_env_var HOST)}
APP_HOST=${APP_HOST:-0.0.0.0}
APP_OLLAMA_HOST=${OLLAMA_HOST:-$(read_env_var OLLAMA_HOST)}
APP_OLLAMA_HOST=${APP_OLLAMA_HOST:-http://127.0.0.1:11434}
APP_OLLAMA_MODEL=${OLLAMA_MODEL:-$(read_env_var OLLAMA_MODEL)}
APP_OLLAMA_MODEL=${APP_OLLAMA_MODEL:-qwen2.5-vl-abliterated:3b}

usage() {
  cat <<USAGE
ImageHive helper

Usage: ./ImageHive <command>
Commands:
  install   Install dependencies and prepare local config
  start     Start the ImageHive server in the background
  stop      Stop the running ImageHive server
  status    Show whether ImageHive is currently running
USAGE
}

need_node() {
  if ! command -v node >/dev/null 2>&1; then
    echo "Node.js is required. Please install Node 18 or newer." >&2
    exit 1
  fi
  local major
  major=$(node -p "process.versions.node.split('.') [0]")
  if [[ "$major" -lt 18 ]]; then
    echo "ImageHive needs Node.js 18+. Detected version: $(node -v)" >&2
    exit 1
  fi
}

ensure_env() {
  if [[ ! -f "$PROJECT_DIR/.env" && -f "$PROJECT_DIR/.env.example" ]]; then
    cp "$PROJECT_DIR/.env.example" "$PROJECT_DIR/.env"
    echo "Created .env from .env.example. Update it with your local settings."
  fi
}

wait_for_health() {
  local attempts=40
  local health_url="http://127.0.0.1:${APP_PORT}/api/health"

  for ((i = 1; i <= attempts; i++)); do
    if curl -fsS --max-time 4 "$health_url" >/tmp/imagehive-health.json 2>/dev/null; then
      if node -e "const fs=require('fs');const [expectedModel,expectedHost]=process.argv.slice(2);const data=JSON.parse(fs.readFileSync('/tmp/imagehive-health.json','utf8'));const ollama=data?.ollama||{};if(!ollama.reachable||!ollama.modelReady)process.exit(1);if(expectedModel&&ollama.model!==expectedModel)process.exit(1);if(expectedHost&&ollama.host&&ollama.host!==expectedHost)process.exit(1);" "$APP_OLLAMA_MODEL" "$APP_OLLAMA_HOST"; then
        echo "ImageHive UI is ready at http://${APP_HOST}:${APP_PORT} (Qwen: ${APP_OLLAMA_MODEL})."
        rm -f /tmp/imagehive-health.json
        return 0
      fi
    fi
    if (( i % 5 == 0 )); then
      echo "Waiting for ImageHive to become ready (attempt $i/${attempts})..."
    fi
    sleep 1
  done

  echo "ImageHive did not become ready. Check $LOG_FILE for details."
  return 1
}

launch_ui() {
  local url="http://localhost:${APP_PORT}"
  if command -v python3 >/dev/null 2>&1; then
    python3 - <<'PY' "$url" || true
import sys
import webbrowser
webbrowser.open(sys.argv[1])
PY
  fi
  echo "Open $url in your browser to use ImageHive."
}

install_cmd() {
  need_node
  cd "$PROJECT_DIR"
  ensure_env
  echo "Installing npm dependencies..."
  $PACKAGE_MANAGER install
  echo "Ensuring Ollama and the Qwen2.5-VL-abliterated:3b model are installed..."
  node scripts/prepare-ollama.js --install
  echo "Defaults are prefilled for Ollama host/model/data dir; only set FAL_API_KEY if you want Fal.ai renders."
  echo "Optional: run '$PACKAGE_MANAGER run check:gpu' to verify GPU visibility."
}

start_cmd() {
  need_node
  cd "$PROJECT_DIR"
  ensure_env

  echo "ImageHive ( Image creation helper engine ) runtime 0.1B by darknet.ca labs."

  if [[ -f "$PID_FILE" ]]; then
    local existing
    existing=$(cat "$PID_FILE")
    if kill -0 "$existing" >/dev/null 2>&1; then
      echo "ImageHive already running with PID $existing."
      echo "Log file: $LOG_FILE"
      exit 0
    else
      echo "Stale PID file found. Cleaning up."
      rm -f "$PID_FILE"
    fi
  fi

  echo "Starting ImageHive..."
  nohup $PACKAGE_MANAGER run start >"$LOG_FILE" 2>&1 &
  echo $! >"$PID_FILE"
  echo "ImageHive started (PID $(cat "$PID_FILE"))."
  echo "Logs: $LOG_FILE"

  # Give the process a moment to start and ensure it is still alive.
  sleep 2
  if ! kill -0 "$(cat "$PID_FILE")" >/dev/null 2>&1; then
    echo "ImageHive failed to start. Review $LOG_FILE for errors." >&2
    rm -f "$PID_FILE"
    exit 1
  fi

  if ! wait_for_health; then
    kill "$(cat "$PID_FILE")" >/dev/null 2>&1 || true
    rm -f "$PID_FILE"
    exit 1
  fi

  launch_ui
}

stop_cmd() {
  if [[ ! -f "$PID_FILE" ]]; then
    echo "No PID file found. ImageHive does not appear to be running."
    return
  fi
  local pid
  pid=$(cat "$PID_FILE")
  if kill -0 "$pid" >/dev/null 2>&1; then
    echo "Stopping ImageHive (PID $pid)..."
    kill "$pid"
    rm -f "$PID_FILE"
    echo "Stopped."
  else
    echo "Process $pid is not running. Cleaning up PID file."
    rm -f "$PID_FILE"
  fi
}

status_cmd() {
  if [[ -f "$PID_FILE" ]]; then
    local pid
    pid=$(cat "$PID_FILE")
    if kill -0 "$pid" >/dev/null 2>&1; then
      echo "ImageHive is running (PID $pid)."
      echo "Logs: $LOG_FILE"
      return
    fi
  fi
  echo "ImageHive is not running."
}

case "${1:-}" in
  install) install_cmd ;;
  start) start_cmd ;;
  stop) stop_cmd ;;
  status) status_cmd ;;
  *) usage ;;
esac
